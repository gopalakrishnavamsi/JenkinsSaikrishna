<aura:component controller="sendEnvelope" implements="force:lightningQuickActionWithoutHeader,force:hasRecordId" access="global" >
    <aura:handler name="init" value="{!this}" action="{!c.init}"/>
    <aura:attribute name="recordId" type="String"/>
    <aura:attribute name="visualforce" type="Boolean"/>
    <aura:attribute name="showAdvancedOptions" type="Boolean"/>
    <aura:attribute name="actionHeight" type="String"/>
    <aura:attribute name="recipientType" type="String"/>
    <aura:attribute name="documents" type="Object[]"/>
    <aura:attribute name="message" type="String"/>
    <aura:attribute name="mode" type="String"/>
    <aura:attribute name="showToast" type="Boolean"/>
    <aura:attribute name="recipientSettings" type="Object[]"/>
    <aura:attribute name="loading" type="Boolean"/>
    <aura:attribute name="emailSubject" type="String"/>
    <aura:attribute name="emailMessage" type="String"/>
    <aura:attribute name="language" type="String"/>
    <aura:attribute name="remind" type="Boolean" default="{!false}"/>
    <aura:attribute name="remindAfterDays" type="Integer" default="{!0}"/>
    <aura:attribute name="remindFrequencyDays" type="Integer" default="{!0}"/>
    <aura:attribute name="expires" type="Boolean" default="{!true}"/>
    <aura:attribute name="expireAfterDays" type="Integer" default="120"/>
    <aura:attribute name="expireWarnDays" type="Integer" default="{!0}"/>
    <aura:attribute name="expiresOn" type="Date"/>
    <aura:attribute name="docuSignTemplates" type="Object[]"/>
    <aura:attribute name="templates" type="Object[]"/>
    <aura:attribute name="activeStep" type="Integer" default="{!0}" access="private"/>
    <aura:attribute name="taggingUrl" type="String"/>
    <aura:attribute name="returnUrl" type="String"/>
    <aura:attribute name="filesSelected" type="Boolean" default="{!false}"/>
    <aura:attribute name="selectedFileTitles" type="String"/>
    <aura:attribute name="currentEditSelection" type="Object"/>
    <aura:attribute name="disableNext" type="Boolean" default="{!true}"/>
    <aura:attribute name="uploadMessage" type="String"/>
    <aura:attribute name="lcHost" type="String"/>
    <aura:attribute name="namespace" type="String"/>
    <aura:attribute name="selectedRecipients" type="Map[]"/>
    <aura:attribute name="recordType" type="String"/>
    
    <aura:handler name="change" value="{!v.uploadMessage}" action="{!c.handleUpload}"/>
    <aura:handler name="change" value="{!v.activeStep}" action="{!c.handleActiveStepChange}"/>
    <aura:handler name="change" value="{!v.filesSelected}" action="{!c.setNextButtonState}"/>
    <aura:handler name="change" value="{!v.templates}" action="{!c.setNextButtonState}"/>
    <aura:handler name="change" value="{!v.emailSubject}" action="{!c.setNextButtonState}"/>
    <aura:handler name="recipientIdChange" event="c:strike_evt" action="{!c.setNextButtonState}"/>

    <div class="{!'slds-scope' + if(v.visualforce, ' ds-visualforce', ' ds-quick-action-modal')}">
        <aura:if isTrue="{!v.visualforce}">
            <!-- Page Header -->
            <div class="ds-visualforce__header slds-page-header slds-border_bottom slds-is-relative">
                <div class="slds-media">
                    <div class="slds-media__figure">
                        <lightning:icon iconName="custom:custom105" class="slds-page-header__icon" />
                    </div>
                    <div class="slds-media__body">
                        <nav>
                        <ol class="slds-breadcrumb slds-line-height_reset">
                            <li class="slds-breadcrumb__item">
                                <span>{!$Label.c.DocuSign}</span>
                            </li>
                        </ol>
                        </nav>
                        <h1 class="slds-page-header__title slds-m-right_small slds-align-middle">{!$Label.c.Send_Envelope}</h1>
                    </div>
                </div>
            </div>
            <!-- /Page Header -->
            <aura:set attribute="else">
                <header class="ds-modal__header slds-modal__header">
                    <h2 class="slds-text-heading_medium slds-hyphenate">{!$Label.c.Send_Envelope}</h2>
                </header>
            </aura:set>
        </aura:if>
        
        <div class="{!if(v.visualforce, 'ds-visualforce__body slds-scrollable slds-container slds-p-around_x-large slds-is-relative', 'slds-modal__content ds-modal__content slds-scrollable slds-p-around_medium' + if(v.loading, ' slds-hidden', ''))}">
            <div class="{!if(v.visualforce, 'slds-container_center slds-container_medium slds-box')}">
                <!-- Files -->
                <div class="{!if(v.activeStep != 0, 'slds-hide')}">
                    <h3 class="slds-text-heading_medium slds-m-bottom_x-small">{!$Label.c.Files}</h3>
                    <div class="slds-m-bottom_small">
                        <c:FileUploader recordId="{!v.recordId}"
                            message="{!v.uploadMessage}"
                            lcHost="{!v.lcHost}"
                            namespace="{!v.namespace}"/>
                    </div>

                    <!-- Files List -->
                    <ul class="slds-has-dividers_bottom-space slds-border_top">
                        <!-- Empty State -->
                        <li class="{!'slds-item ds-files__empty-state' + if(v.loading, ' slds-hidden')}">
                            <div class="slds-text-color_weak slds-p-vertical_xx-small slds-m-top_xxx-small slds-m-bottom_xx-small">
                                <em>{!$Label.c.No_Files}</em>
                            </div>
                        </li>
                        <!-- /Empty State -->

                        <!-- Attached Files -->
                        <aura:iteration items="{!v.documents}" var="document" indexVar="documentIndex">
                            <li class="slds-item slds-p-vertical_small">
                                <article class="slds-tile slds-media">
                                    <div class="slds-media__figure">
                                        <lightning:input aura:id="file-checkbox" name="{!document.Title}" type="checkbox" checked="{!document.checked}" value="{!documentIndex}" label="{!$Label.c.Select}" class="ds-no-label" onchange="{!c.handleFileSelected}"/>
                                    </div>
                                    <div class="slds-media__figure">
                                        <!-- File Icon -->
                                        <lightning:icon iconName="{!
                                            'doctype:'
                                            + if(document.FileExtension == 'doc', 'gdoc')
                                            + if(document.FileExtension == 'docm', 'gdoc')
                                            + if(document.FileExtension == 'docx', 'gdoc')
                                            + if(document.FileExtension == 'dot', 'gdoc')
                                            + if(document.FileExtension == 'dotm', 'gdoc')
                                            + if(document.FileExtension == 'dotx', 'gdoc')
                                            + if(document.FileExtension == 'htm', 'html')
                                            + if(document.FileExtension == 'html', 'html')
                                            + if(document.FileExtension == 'msg', 'unknown')
                                            + if(document.FileExtension == 'pdf', 'pdf')
                                            + if(document.FileExtension == 'rtf', 'gdoc')
                                            + if(document.FileExtension == 'txt', 'gdoc')
                                            + if(document.FileExtension == 'wpd', 'gdoc')
                                            + if(document.FileExtension == 'xps', 'unknown')
                                            + if(document.FileExtension == 'bmp', 'image')
                                            + if(document.FileExtension == 'gif', 'image')
                                            + if(document.FileExtension == 'jpg', 'image')
                                            + if(document.FileExtension == 'jpeg', 'image')
                                            + if(document.FileExtension == 'png', 'image')
                                            + if(document.FileExtension == 'tif', 'image')
                                            + if(document.FileExtension == 'tiff', 'image')
                                            + if(document.FileExtension == 'pot', 'slide')
                                            + if(document.FileExtension == 'potx', 'slide')
                                            + if(document.FileExtension == 'pps', 'slide')
                                            + if(document.FileExtension == 'ppt', 'slide')
                                            + if(document.FileExtension == 'pptm', 'slide')
                                            + if(document.FileExtension == 'pptx', 'slide')
                                            + if(document.FileExtension == 'csv', 'gsheet')
                                            + if(document.FileExtension == 'xls', 'gsheet')
                                            + if(document.FileExtension == 'xlsm', 'gsheet')
                                            + if(document.FileExtension == 'xlsx', 'gsheet')
                                        }"/>
                                        <!-- /File Icon -->
                                    </div>
                                    <div class="slds-media__body">
                                        <h3 class="slds-tile__title slds-truncate" title="{!document.Title}">
                                            <a href="javascript:void(0);">{!document.Title}</a>
                                        </h3>
                                        <div class="slds-tile__detail slds-truncate">
                                            {!document.CreatedDate} • {!document.ContentSize} • {!document.FileType}</div>
                                    </div>
                                </article>
                            </li>
                        </aura:iteration>
                        <!-- /Attached Files -->

                        <!-- Templates -->
                        <aura:iteration items="{!v.templates}" var="template" indexVar="index">
                            <li class="slds-item">
                                <div class="slds-grid slds-grid_vertical-align-center slds-gutters_xx-small">
                                    <div class="slds-col slds-form-element_label slds-m-bottom_none slds-no-flex">
                                        {!$Label.c.Template}
                                    </div>
                                    <div class="slds-col">
                                        <lightning:select class="ds-no-label slds-p-left_x-small" onchange="{!c.setTemplate}" value="{#template.id.value}" name="{!index}">
                                            <aura:iteration items="{!v.docuSignTemplates}" var="docuSignTemplate">
                                                <option value="{!docuSignTemplate.id.value}" disabled="{!docuSignTemplate.selected}">{!docuSignTemplate.name}</option>
                                            </aura:iteration>
                                        </lightning:select>
                                    </div>
                                    <div class="slds-col slds-no-flex">
                                        <lightning:buttonIcon iconName="utility:close" variant="container" alternativeText="{!$Label.c.Remove}" class="slds-button ds-remove" onclick="{!c.removeTemplate}" value="{!index}"/>
                                    </div>
                                </div>
                            </li>
                        </aura:iteration>
                        <!-- /Templates -->
                    </ul>
                    
                    <!-- Add Template -->
                    <aura:if isTrue="{!not(empty(v.docuSignTemplates))}">
                        <lightning:button label="{!$Label.c.Add_Template}" class="slds-m-top_small" iconName="utility:add" onclick="{!c.addTemplate}" disabled="{!v.docuSignTemplates.length == v.templates.length}"/>
                    </aura:if>
                    <!-- /Add Template -->
                    
                    <!-- Focus Catcher
                        * The purpose of this element is to allow us to manually blur out of lightning:selects (they don't have a blur method).
                        * When dealing with two iterations, the component throws an error during its call to refocus and update its aria-describedby attribute upon option selection.
                    -->
                    <div tabindex="-1" aura:id="focus-catcher"></div>
                    <!-- /Focus Catcher -->
                    
                    <!-- /Files List -->
                </div>
                <!-- /Files -->

                <!-- Recipients -->
                <div class="{!if(v.activeStep != 1, 'slds-hide')}">
                    <aura:if isTrue="{!v.filesSelected}">
                        <h3 class="slds-text-heading_medium">{!$Label.c.Recipients}</h3>
                        <div class="slds-box slds-box_x-small slds-theme_shade slds-m-top_small">
                            <h4 class="slds-text-heading_label slds-truncate" title="{!v.selectedFileTitles}">{!v.selectedFileTitles}</h4>
                            <div class="ds-recipients">
                                <aura:iteration items="{!v.recipientSettings}" var="recipient" indexVar="recipientIndex">
                                   <aura:if isTrue="{!empty(recipient.role)}">
                                        <div class="ds-recipients__recipient slds-m-top_small slds-is-relative">
                                            <div class="slds-grid slds-grid_vertical-align-center slds-gutters_xx-small">
                                                <div class="slds-col">
                                                    <c:recipientTile
                                                        recipientId="{!recipient.id}"
                                                        recipientType="{!recipient.recipientType}"
                                                        authenticationValue="{!recipient.authentication.accessCode}"
                                                        message="{!recipient.note}"
                                                        language="{!recipient.emailSettings.language}"
                                                        emailSubject="{!recipient.emailSettings.subject}"
                                                        emailBody="{!recipient.emailSettings.message}"
                                                        onEditAccessAuthentication="{!c.handleEditAccessAuthentication}"
                                                        onEditPrivateMessage="{!c.handleEditPrivateMessage}"
                                                        onEditCustomEmailMessage="{!c.handleEditCustomEmailMessage}"
                                                        index="{!recipientIndex}"
                                                        name="{#recipient.name}"
                                                        recordType="{!v.recordType}"
                                                        />
                                                </div>
                                                <div class="slds-col slds-no-flex">
                                                    <lightning:buttonIcon iconName="utility:close" variant="container" alternativeText="{!$Label.c.Remove}" class="slds-button ds-remove slds-m-top_xx-small slds-m-right_xx-small" onclick="{!c.removeRecipient}" value="{!recipientIndex}"/>
                                                </div>
                                            </div>
                                       </div>
                                    </aura:if>
                                </aura:iteration>
                            </div>
                            <lightning:button class="slds-m-top_small" label="{!$Label.c.Add_Recipient}" onclick="{!c.addRecipient}"/>
                        </div>
                    </aura:if>
                    <aura:if isTrue="{!not(empty(v.templates))}">
                        <h3 class="{!'slds-text-heading_medium' + if(v.filesSelected, ' slds-m-top_large')}">{!$Label.c.Template_Roles}</h3>
                        
                        <aura:iteration items="{!v.templates}" var="template">
                            <div class="ds-template-roles slds-box slds-box_x-small slds-theme_shade slds-m-top_small">
                                <div class="ds-template-roles__title slds-grid slds-gutters_xx-small">
                                    <h4 class="slds-col slds-text-heading_label">{!template.name}</h4>
                                    <aura:if isTrue="{!empty(template.recipients)}">
                                        <!-- Empty State -->
                                        <div class="slds-col slds-no-flex slds-text-body_small slds-text-color_weak slds-line-height_reset slds-p-top_xxx-small">
                                            <lightning:icon iconName="utility:warning" size="xx-small" variant="warning" class="ds-icon-adjustment slds-m-right_xx-small" />
                                            <em>{!$Label.c.No_Roles}</em>
                                        </div>
                                        <!-- Empty State -->
                                    </aura:if>
                                </div>
                                <aura:iteration items="{!template.recipients}" var="recipient" indexVar="index">
                                    <div class="ds-template-roles__role slds-m-top_small slds-is-relative">
                                        <c:recipientTile
                                            recipientId="{!recipient.id}"
                                            role="{!recipient.role.name}"
                                            authenticationValue="{!recipient.authentication.accessCode}"
                                            message="{!recipient.note}"
                                            language="{!recipient.emailSettings.language}"
                                            emailSubject="{!recipient.emailSettings.subject}"
                                            emailBody="{!recipient.emailSettings.message}"
                                            onEditAccessAuthentication="{!c.handleEditAccessAuthentication}"
                                            onEditPrivateMessage="{!c.handleEditPrivateMessage}"
                                            onEditCustomEmailMessage="{!c.handleEditCustomEmailMessage}"
                                            templateId="{!template.id}"
                                            index="{!index}"
                                            recordType="{!v.recordType}"
                                            />
                                    </div>
                                </aura:iteration>
                            </div>
                        </aura:iteration>
                    </aura:if>
                </div>
                <!-- /Recipients -->

                <!-- Additional Settings -->
                <div class="{!if(v.activeStep != 2, 'slds-hide')}">
                    <h3 class="slds-m-bottom_x-small">
                        <span class="slds-text-heading_medium slds-show_inline-block">{!$Label.c.Email_Message}</span>
                        <lightning:helptext class="slds-m-left_x-small ds-icon-adjustment" content="{!$Label.c.Email_Helptext}" />
                    </h3>
                    <div class="slds-form_stacked">
                        <lightning:select class="slds-form-element" value="{!v.language}" name="{!$Label.c.Language}" label="{!$Label.c.Language}">
                            <option value="english-us">{!$Label.c.English_US}</option>
                            <option value="english-uk">{!$Label.c.English_UK}</option>
                        </lightning:select>
                        <lightning:input class="slds-form-element" aura:id="envelope-subject-input" value="{!v.emailSubject}" name="Subject" label="{!$Label.c.Subject}" required="true"/>
                        <lightning:textarea class="slds-form-element" value="{!v.emailMessage}" name="{!$Label.c.Message}" label="{!$Label.c.Message}"/>
                    </div>
                    
                    <div class="slds-m-top_large">
                        <h3 class="slds-text-heading_medium slds-show_inline-block slds-m-right_small">{!$Label.c.Advanced_Options}</h3>
                        <a href="javascript:void(0);" onclick="{!c.toggleAdvancedOptions}">{!if(v.showAdvancedOptions, $Label.c.Hide, $Label.c.Show)}</a>
                    </div>
                    
                    <aura:if isTrue="{!v.showAdvancedOptions}">
                    <h4 class="slds-text-heading_label slds-m-bottom_x-small slds-p-top_small">{!$Label.c.Reminders}</h4>
                        <lightning:input type="checkbox" name="{!$Label.c.Automatic_Reminders}" label="{!$Label.c.Set_Reminders}" checked="{!v.remind}"/>
                        <p class="{!'slds-m-top_x-small slds-p-left_large' + if(v.remind, ' slds-text-color_weak', '')}">
                            <lightning:input class="ds-input_inline slds-m-right_small" variant="label-hidden" type="number" name="{!$Label.c.Days_Before_First_Dash}" label="{!$Label.c.Days_Before}" value="{!v.remindAfterDays}" min="0" disabled="{!not(v.remind)}"/>
                            <span class="slds-form-element__label">{!$Label.c.Days_Before_First}</span>
                        </p>
                        <p class="{!'slds-m-top_x-small slds-p-left_large' + if(v.remind, ' slds-text-color_weak', '')}">
                            <lightning:input class="ds-input_inline slds-m-right_small" variant="label-hidden" type="number" name="{!$Label.c.Days_Between_Dash}" label="{!$Label.c.Days_Between_Dash}" value="{!v.remindFrequencyDays}" min="0" disabled="{!not(v.remind)}"/>
                            <span class="slds-form-element__label">{!$Label.c.Days_Between}</span>
                        </p>
                        <h4 class="slds-text-heading_label slds-m-top_medium slds-m-bottom_x-small">{!$Label.c.Expiration}</h4>
                        <lightning:input type="checkbox" name="{!$Label.c.Expires_Lower}" label="{!$Label.c.Envelope_Expires}" checked="{!v.expires}"/>
                        <p class="{!'slds-m-top_x-small slds-p-left_large' + if(v.expires, ' slds-text-color_weak', '')}">
                            <lightning:input class="ds-input_inline slds-m-right_small" variant="label-hidden" type="number" name="days-before-request-expires" label="{!$Label.c.Days_Before_Expires_Dash}" value="{!v.expireAfterDays}" min="0" disabled="{!not(v.expires)}" onblur="{!c.handleExpiresOn}"/>
                            <span class="slds-form-element__label">{!$Label.c.Days_Before_Expires}</span>
                        </p>
                        <p class="slds-m-vertical_x-small slds-p-left_large">
                            <em class="slds-text-color_weak">({!$Label.c.Expires_On}&nbsp;
                                <strong>
                                    <lightning:formattedDateTime
                                        hour12="true"
                                        value="{!v.expiresOn}"
                                    />
                                </strong>)
                            </em>
                        </p>
                        <p class="{!'slds-m-top_x-small slds-p-left_large' + if(v.expires, ' slds-text-color_weak', '')}">
                            <lightning:input class="ds-input_inline slds-m-right_small" variant="label-hidden" type="number" name="{!$Label.c.Days_Before_Warn_Dash}" label="{!$Label.c.Days_Before_Warn_Dash}" value="{!v.expireWarnDays}" min="0" disabled="{!not(v.expires)}"/>
                            <span class="slds-form-element__label">{!$Label.c.Days_Before_Warn}</span>
                        </p>
                    </aura:if>
                </div>
                <!-- /Additional Settings -->

                <!-- Loading State -->
                <aura:if isTrue="{!v.loading}">
                    <lightning:spinner class="{!if(v.visualforce, 'ds-spinner_visualforce')}" size="large" />
                </aura:if>
                <!-- /Loading State -->
            </div>
        </div>

        <div class="{!'slds-is-relative' + if(v.visualforce, ' ds-visualforce__footer slds-p-horizontal_large slds-p-vertical_medium', ' ds-modal__footer slds-modal__footer')}">
            <div class="slds-grid slds-gutters_x-small">
                <aura:if isTrue="{!v.activeStep gt 0}">
                    <div class="slds-col slds-no-flex">
                        <lightning:button disabled="{!v.loading}" variant="neutral" label="{!$Label.c.Back}" onclick="{!c.goBack}" />
                    </div>
                    <aura:set attribute="else">
                        <lightning:button disabled="{!v.loading}" variant="neutral" label="{!$Label.c.Cancel}" onclick="{!c.cancel}" />
                    </aura:set>
                </aura:if>
                <div class="slds-col">
                    <!-- Step Indicators -->
                    <ul class="slds-carousel__indicators slds-is-absolute ds-carousel__indicators">
                        <li class="slds-carousel__indicator">
                            <div class="{!'slds-carousel__indicator-action' + if(v.activeStep == 0, ' slds-is-active')}" role="tab" title="{!$Label.c.Files}"></div>
                        </li>
                        <li class="slds-carousel__indicator">
                            <div class="{!'slds-carousel__indicator-action' + if(v.activeStep == 1, ' slds-is-active')}" role="tab" title="{!$Label.c.Recipients}"></div>
                        </li>
                        <li class="slds-carousel__indicator">
                            <div class="{!'slds-carousel__indicator-action' + if(v.activeStep == 2, ' slds-is-active')}" role="tab" title="{!$Label.c.Advanced_Options}"></div>
                        </li>
                    </ul>
                    <!-- /Step Indicators -->
                </div>
                <div class="slds-col slds-no-flex">
                    <lightning:button variant="brand" disabled="{!or(v.disableNext, v.loading)}" label="{!if(v.activeStep == 2, $Label.c.Continue_And_Tag, $Label.c.Next)}" onclick="{!if(v.activeStep == 2, c.navigateToTagging, c.goNext)}" />
                </div>
            </div>
        </div>
        <!-- Toast -->
        <c:toast message="{!v.message}" mode="{!v.mode}" showToast="{!v.showToast}" inVfPage="{!true}"/>
        <!-- /Toast -->
    </div>
</aura:component>
