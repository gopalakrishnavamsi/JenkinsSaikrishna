<aura:component controller="SetupController">
    <aura:attribute name="activeStep" type="Integer"/>
    <aura:attribute name="section" type="Object"/>
    <aura:attribute name="selectedSection" type="String"/>
    <aura:attribute name="continueButtonDisabled" type="Boolean"/>
    <aura:attribute name="helpInfo" type="String"/>
    <aura:attribute name="message" type="String"/>
    <aura:attribute name="mode" type="String"/>
    <aura:attribute name="showToast" type="Boolean"/>

    <!-- Demo Attributes -->
    <aura:attribute name="loggedIn" type="Boolean"/>
    <aura:attribute name="showTrialFields" type="Boolean" access="private"/>
    <aura:attribute name="signedUpForTrial" type="Boolean" access="private"/>
    <aura:attribute name="showLoginSpinner" type="Boolean"/>
    <aura:attribute name="associatedAccounts" type="AccountService.AccountOption[]"/>
    <aura:attribute name="showAccountSelectionModal" type="Boolean"/>
    <aura:attribute name="isTrial" type="Boolean"/>
    <aura:attribute name="trialMessage" type="String"/>
    <aura:attribute name="trialIsExpired" type="Boolean"/>
    <aura:attribute name="emailAddress" type="String"/>
    <aura:attribute name="password" type="String"/>
    <aura:attribute name="showLogoutModal" type="Boolean"/>
    <aura:attribute name="advancedOptionsExpanded" type="Boolean"/>
    <aura:attribute name="environment" type="String"/>
    <aura:attribute name="otherUrl" type="String"/>

    <aura:attribute name="accountNumber" type="String"/>
    <aura:handler name="change" value="{!v.accountNumber}" action="{!c.handleAccountChange}"/>
    <!-- /Demo Attributes -->

    <aura:handler name="init" value="{!this}" action="{!c.initialize}"/>
    <aura:handler name="change" value="{!v.selectedSection}" action="{!c.handleSelectedSectionActiveStepChange}"/>
    <aura:handler name="change" value="{!v.activeStep}" action="{!c.handleSelectedSectionActiveStepChange}"/>
    <aura:handler name="change" value="{!v.loggedIn}" action="{!c.handleLoginChange}"/>
    <aura:registerEvent name="saveToBackend" type="c:SaveDataEvent"/>

    <div class="slds-scope">
        <!--<h3 class="strike-wizard__step-title">Log into DocuSign</h3> -->
        <!-- <p class="strike-wizard__step-description">Enter your credentials for an existing account, or sign up for a free trial</p>-->

        <!-- Help Info -->
        <aura:if isTrue="{!not(empty(v.helpInfo))}">
            <div class="slds-m-bottom_large">
                <div class="strike-notify slds-notify slds-notify_toast slds-theme_info" role="alert">
                    <span class="slds-assistive-text">{!$Label.c.Info}</span>
                    <span class="slds-icon_container slds-icon-utility-info slds-m-right_small slds-no-flex slds-align-top"
                          title="{!$Label.c.Info}">
                        <lightning:icon iconName="utility:info" size="small" variant="inverse"/>
                    </span>
                    <div class="slds-notify__content">
                        <ui:outputRichText class="slds-text-longform" value="{!v.helpInfo}"/>
                    </div>
                </div>
            </div>
        </aura:if>
        <!-- /Help Info -->

        <div class="ds-login-box slds-box slds-theme_default slds-is-relative">
            <!-- Loading State -->
            <aura:if isTrue="{!v.showLoginSpinner}">
                <lightning:spinner/>
            </aura:if>
            <!-- /Loading State -->

            <aura:if isTrue="{!v.loggedIn}">
                <!-- Logged In State -->
                <div>
                    <aura:if isTrue="{!v.accountNumber}">
                        <div class="{!'slds-notify slds-notify_alert slds-theme_alert-texture' + if(and(v.isTrial, v.trialIsExpired), ' slds-theme_warning', ' slds-theme_success')}"
                             role="alert">
                            <lightning:icon size="x-small" iconName="utility:user" variant="inverse"
                                            class="slds-m-right_x-small"/>
                            <aura:if isTrue="{!and(v.isTrial, v.trialIsExpired)}">
                                <h2>{!format($Label.c.TrialExpired_2, v.emailAddress, v.accountNumber)}</h2>
                                <aura:set attribute="else">
                                    <h2>{!format($Label.c.LoggedInAs_2, v.emailAddress, v.accountNumber)}</h2>
                                </aura:set>
                            </aura:if>
                        </div>

                        <aura:if isTrue="{!and(v.isTrial, not(v.trialIsExpired))}">
                            <p class="slds-m-top_medium"><em>{!v.trialMessage}</em></p>
                        </aura:if>

                        <div class="slds-text-align_right slds-m-top_medium">
                            <lightning:button label="{!$Label.c.Upgrade}" variant="neutral"
                                              class="{!if(v.isTrial, '', 'slds-hide')}"
                                              onclick="{!c.navigateToUpgrade}"/>
                            <lightning:button label="{!$Label.c.Logout}" variant="neutral"
                                              onclick="{!c.showLogoutModal}"/>
                        </div>
                    </aura:if>
                </div>
                <!-- /Logged In State -->

                <aura:set attribute="else">
                    <!-- Logged Out State -->
                    <div>
                        <aura:if isTrue="{!v.signedUpForTrial}">
                            <!-- Signed Up State -->
                            <div class="ds-border-radius slds-scoped-notification slds-media slds-theme_success"
                                 role="status">
                                <div class="slds-media__figure">
                                    <lightning:icon iconName="utility:success" size="small" variant="inverse"/>
                                </div>
                                <div class="slds-media__body">
                                    <p>{!$Label.c.TrialInstructions}</p>
                                </div>
                            </div>

                            <div class="slds-m-top_medium slds-text-align_right">
                                <lightning:button label="{!$Label.c.ContinueToLogIn}" variant="brand"
                                                  onclick="{!c.continueToLogIn}"/>
                            </div>
                            <!-- /Signed Up State -->

                            <aura:set attribute="else">
                                <div>
                                    <aura:if isTrue="{!v.showTrialFields}">
                                        <!-- Trial Fields -->
                                        <h4 class="slds-text-align_center slds-text-heading_small slds-m-bottom_small">{!$Label.c.TryDocuSign}</h4>
                                        <lightning:input aura:id="trial-input" type="email" label="Email Address"
                                                         value="{!v.emailAddress}"/>

                                        <div class="slds-m-top_medium">
                                            <div class="slds-grid slds-gutters_x-small slds-grid_vertical-align-center">
                                                <div class="slds-col">
                                                    <small class="slds-text-body_small">
                                                        <em class="slds-text-color_weak">
                                                            <aura:unescapedHtml value="{!$Label.c.ClickGetStarted}"/>
                                                        </em>
                                                    </small>
                                                </div>
                                                <div class="slds-col slds-no-flex">
                                                    <lightning:button aura:id="trial-button"
                                                                      label="{!$Label.c.GetStarted}" variant="brand"
                                                                      onclick="{!c.getStarted}"/>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- /Trial Fields -->

                                        <aura:set attribute="else">
                                            <!-- Log In Fields -->
                                            <h4 class="slds-text-align_center slds-text-heading_small slds-m-bottom_small">{!$Label.c.PleaseLogIn}</h4>
                                            <lightning:input aura:id="login-input" type="email"
                                                             label="{!$Label.c.EmailAddress}"
                                                             value="{!v.emailAddress}"/>
                                            <div class="ds-no-focus" onkeyup="{!c.handlePasswordKeyup}" tabindex="-1">
                                                <lightning:input aura:id="password-input" type="password"
                                                                 label="{!$Label.c.Password}" value="{!v.password}"
                                                                 class="slds-p-top_x-small"/>
                                            </div>
                                            <div class="{! 'slds-section' + (v.advancedOptionsExpanded ? ' slds-is-open' : '')}">
                                                <button aria-controls="advanced-options"
                                                        aria-expanded="{!v.advancedOptionsExpanded}"
                                                        onclick="{!c.toggleAdvancedOptions}"
                                                        class="slds-button slds-section__title-action">
                                                    <lightning:icon iconName="{!v.advancedOptionsExpanded ? 'utility:chevrondown' : 'utility:chevronright'}"
                                                                    size="xx-small"
                                                                    alternativeText="expand advanced options"/>
                                                    <span class="slds-section__title_xx-small">{!$Label.c.AdvancedOptions}</span>
                                                </button>
                                                <div id="advanced-options" class="slds-section__content">
                                                    <lightning:select aura:id="ds-environment"
                                                                      label="{!$Label.c.Environment}"
                                                                      value="{!v.environment}">
                                                        <option value="prod" selected="selected">{!$Label.c.Production}</option>
                                                        <option value="demo">{!$Label.c.Demo}</option>
                                                        <option value="other">{!$Label.c.Other}</option>
                                                    </lightning:select>
                                                    <lightning:input aura:id="ds-other-url"
                                                                     class="{!'slds-p-top_x-small ' + (v.environment == 'other' ? 'slds-show' : 'slds-hide')}"
                                                                     label="{!$Label.c.OtherUrl}"
                                                                     type="url"
                                                                     value="{!v.otherUrl}"/>
                                                </div>
                                            </div>
                                            <div class="slds-m-top_medium slds-text-align_right">
                                                <lightning:button aura:id="login-button" label="{!$Label.c.LogIn}"
                                                                  variant="brand" onclick="{!c.loginToDocuSign}"/>
                                            </div>
                                            <!-- /Log In Fields -->
                                        </aura:set>
                                    </aura:if>
                                </div>
                            </aura:set>
                        </aura:if>
                    </div>

                    <!-- Account Selection Modal -->
                    <c:strike_modal showModal="{!v.showAccountSelectionModal}" title="Select Account">
                        <p class="slds-m-bottom_small">{!$Label.c.MultipleAccountsMessage}</p>
                        <lightning:select value="{!v.accountNumber}" label="Account Number">
                            <aura:if isTrue="{!not(empty(v.associatedAccounts))}">
                                <option value="" disabled="disabled" selected="selected">-- {!$Label.c.SelectLabel} --
                                </option>
                                <aura:iteration items="{!v.associatedAccounts}" var="account" indexVar="index">
                                    <option value="{!account.accountNumber}">{!account.accountNumber}</option>
                                </aura:iteration>
                            </aura:if>
                        </lightning:select>
                        <aura:set attribute="footerButtons">
                            <lightning:button variant="neutral" label="{!$Label.c.Cancel}"
                                              onclick="{!c.cancelSelectAccount}"/>
                            <lightning:button variant="brand" label="{!$Label.c.SelectLabel}"
                                              onclick="{!c.selectAccount}"/>
                        </aura:set>
                    </c:strike_modal>
                    <!-- /Account Selection Modal -->

                    <!-- /Logged Out State -->
                </aura:set>
            </aura:if>
        </div>

        <aura:if isTrue="{!and(not(v.signedUpForTrial), not(v.loggedIn))}">
            <div class="slds-m-vertical_large slds-text-align_center">
                <a href="javascript:void(0)" onclick="{!c.swapLogInState}">
                    <aura:if isTrue="{!v.showTrialFields}">
                    {!$Label.c.LogInToExisting}
                        <aura:set attribute="else">
                                {!$Label.c.NoAccount}
                        </aura:set>
                    </aura:if>
                </a>
            </div>
        </aura:if>

        <!-- Logout Modal -->
        <c:strike_modal aura:id="modal"
                        title="{!$Label.c.LogOut}"
                        variant="error"
                        showModal="{!v.showLogoutModal}">
            <p class="slds-text-align_center">{!format($Label.c.LogoutConfirm_1, v.emailAddress)}</p>

            <aura:set attribute="footerButtons">
                <lightning:button label="{!$Label.c.Cancel}" onclick="{!c.hideLogoutModal}"/>
                <lightning:button label="{!$Label.c.LogOut}" variant="brand" onclick="{!c.logoutOfDocuSign}"/>
            </aura:set>
        </c:strike_modal>
        <!-- /Logout Modal -->
    </div>
</aura:component>
