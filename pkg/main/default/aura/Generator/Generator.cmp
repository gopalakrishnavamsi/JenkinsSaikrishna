<aura:component controller="GenController">

    <ltng:require scripts="{!$Resource.stringUtils}"/>

    <aura:attribute name="config" type="Object"/>
    <aura:attribute name="cvTitleByJobId" type="Object"/>
    <aura:attribute name="lookupObjs" type="Object[]"/>
    <aura:attribute name="failedFiles" type="Object[]"/>
    <aura:attribute name="templateFiles" type="Object[]"/>
    <aura:attribute name="templateId" type="String" access="global"/>
    <aura:attribute name="recordId" type="String" access="global"/>
    <aura:attribute name="errMsg" type="String" access="global"/>
    <aura:attribute name="errType" type="String"/>
    <aura:attribute name="bannerState" type="String" default="success"/>
    <aura:attribute name="bannerMsg" type="String"/>
    <aura:attribute name="generatedFiles" type="String[]"/>
    <aura:attribute name="jobIds" type="String[]"/>
    <aura:attribute name="isMultiCurrency" type="Boolean" default="{!false}"/>
    <aura:attribute name="isGenerating" type="Boolean" default="{!false}" access="global"/>
    <aura:attribute name="isLoading" type="Boolean" default="{!true}"/>
    <aura:attribute name="finishedGenerating" type="Boolean" default="{!false}" access="global"/>
    <aura:attribute name="isClassic" type="Boolean" default="{!false}"/>
    <aura:attribute name="isPreview" type="Boolean" default="{!false}"/>
    <aura:attribute name="showGenerateButton" type="Boolean" default="{!false}"/>
    <aura:attribute name="disableGenerateButton" type="Boolean" default="{!false}" access="global"/>
    <aura:attribute name="showTakingTooLongMessage" type="Boolean" default="{!false}"/>
    <aura:attribute name="isAuthorized" type="Boolean" default="{!false}" access="private"/>
    <aura:attribute name="fetchingOAuthStatus" type="Boolean" default="true"/>

    <aura:handler name="change" value="{!v.isAuthorized}" action="{!c.onChangeIsAuthorized}"/>
   

    <aura:registerEvent name="generatedDocs" type="c:strike_evt"/>

    <aura:method name="generateDocs" action="{!c.generateDocs}" access="global"/>


    <div class="slds-scope slds-is-relative">
        <aura:if isTrue="{!and(not(v.isClassic), not(v.isPreview))}">
            <!-- The below input suppresses the effects of Lightning Quick Action autofocusing, which causes the modal to open scrolled to the end (nearest rendered input; template selection checkboxes) -->
            <input type="text" class="slds-is-absolute" style="opacity: 0;" onfocus="{!c.removeFocusCatcher}"/>
        </aura:if>

        <aura:if isTrue="{!and(not(empty(v.errMsg)), v.isAuthorized)}">
            <div class="{!'slds-m-around_none slds-notify slds-notify_toast slds-grid slds-grid_align-center slds-theme_' + v.errType}"
                 role="alert">
                <lightning:icon iconName="{!'utility:' + v.errType}" variant="inverse" size="small"
                                class="slds-m-right_small slds-no-flex slds-align-top"/>
                <div class="slds-notify__content">
                    <h2 class="slds-text-heading_small">{!v.errMsg}</h2>
                </div>
            </div>
        </aura:if>

          <c:AuthorizeApplication isAuthorized="{!v.isAuthorized}"
                                                fetchingOAuthStatus="{!v.fetchingOAuthStatus}"/> 

        <aura:if isTrue="{!and( empty(v.errMsg), and( not(empty(v.config)), not(empty(v.templateFiles)) ),v.isAuthorized )}">
            <aura:if isTrue="{!or(v.isLoading, v.isGenerating)}">
                <div
                        class="{!'ds-generator-spinner_container' + if(v.isGenerating, ' ds-spinner_generating-container' + if(and(not(v.isPreview), v.isClassic), ' slds-box slds-is-relative'))}">
                    <lightning:spinner alternativeText="Generating" size="if(v.isClassic, 'large', 'small')"
                                       class="{!if(v.showTakingTooLongMessage, 'ds-spinner_long-gen')}"/>
                    <aura:if isTrue="{!v.showTakingTooLongMessage}">
                        <div class="ds-long-gen slds-is-absolute slds-text-align_center">
                            <aura:if isTrue="{!v.isPreview}">
                                {!$Label.c.GeneratorComeBackMsg}
                                <aura:set attribute="else">
									{!$Label.c.GeneratorTooLongMsg}
								</aura:set>
                            </aura:if>
                        </div>
                    </aura:if>
                </div>
            </aura:if>

            <aura:if isTrue="{!not(v.isGenerating)}">
                <aura:if isTrue="{!not(v.finishedGenerating)}">
                    <div class="{!if(and(not(v.isPreview), v.isClassic), 'slds-box')}">
                        <aura:if
                                isTrue="{!not(and(v.config.objectMappings.length == 1, v.config.useCurrentRecord, v.config.useAllTemplates ))}">
							{!v.body}
						</aura:if>
                        <div
                                class="{!'slds-text-align_left slds-form_stacked' + if(and(v.config.useCurrentRecord, not(v.isPreview)), ' slds-hide', '')}">
                            <c:strike_lookup aura:id="recordLookup" value="{!v.recordId}"
                                             label="{!v.config.objectMappings[0].label}"
                                             object="{!v.config.objectMappings[0].apiName}" searchField="Name"
                                             placeholder="{!$Label.c.SelectAnOptionNoDash}" order="Name" limit="5"
                                             loadingMessage="{!$Label.c.Loading}" required="true"
                                             errorMessage="{!$Label.c.InvalidInput}" isDocuSignGenPreview="true"/>
                        </div>

                        <aura:iteration items="{!v.lookupObjs}" start="{!1}" var="lookup" indexVar="index">
                            <div class="slds-text-align_left slds-form_stacked">
                                <!-- Iterate Objects and Signers Here -->
                                <c:strike_lookup aura:id="recordLookup" value="{!lookup.value}" label="{!lookup.label}"
                                                 object="{!lookup.apiName}" searchField="Name"
                                                 placeholder="{!$Label.c.SelectAnOptionNoDash}" order="Name"
                                                 limit="5"
                                                 loadingMessage="{!$Label.c.Loading}" required="true"
                                                 errorMessage="{!$Label.c.InvalidInput}" isDocuSignGenPreview="true"/>
                                <!-- Iterate Objects and Signers Here -->
                            </div>
                        </aura:iteration>

                        <aura:if
                                isTrue="{!and( or(v.isPreview, not(v.config.useAllTemplates)), v.templateFiles.length > 1)}">
                            <!-- Template Selection -->
                            <div class="slds-text-align_left slds-form_stacked">
                                <div class="slds-form-element">
                                    <div class="slds-form-element__label">{!$Label.c.Templates}</div>
                                    <!-- Template -->
                                    <aura:iteration items="{!v.templateFiles}" var="file">
                                        <div class="slds-grid slds-gutters_direct-xx-small slds-m-bottom_small">
                                            <div class="slds-col slds-no-flex">
                                                <lightning:input type="checkbox" label="{!$Label.c.Select}"
                                                                 checked="{!file.isChecked}"
                                                                 class="ds-checkbox_large slds-no-label"
                                                                 onchange="{!c.checkRemaingFiles}"/>
                                            </div>
                                            <div class="slds-col slds-grow slds-has-flexi-truncate">
                                                <c:GenFileTile file="{!file}" isEdit="false"
                                                               isClassic="{!v.isClassic}"/>
                                            </div>
                                        </div>
                                    </aura:iteration>
                                    <!-- /Template -->
                                </div>
                            </div>
                            <!-- /Template Selection -->
                        </aura:if>
                    </div>

                    <aura:if isTrue="{!v.showGenerateButton}">
                        <div class="{!'slds-m-top_medium' + if(v.isClassic, ' slds-text-align_right')}">
                            <lightning:button label="{!if(v.isPreview, $Label.c.PreviewStep, $Label.c.Generate)}"
                                              onclick="{!c.generateDocs}" disabled="{!v.disableGenerateButton}"/>
                        </div>
                    </aura:if>
                </aura:if>

                <aura:if isTrue="{!v.finishedGenerating}">
                    <div class="{!if(and(not(v.isPreview), v.isClassic), 'slds-box')}">
                        <div class="slds-notify_container slds-is-static">
                            <div class="{!'ds-toast slds-m-around_none slds-notify slds-notify_toast slds-grid slds-grid_align-center slds-theme_' + v.bannerState}"
                                 role="alert">
                                <lightning:icon iconName="{!'utility:' + v.bannerState}" variant="inverse" size="small"
                                                class="slds-m-right_small slds-no-flex slds-align-top"/>
                                <div class="slds-notify__content">
                                    <h2 class="slds-text-heading_small">{!v.bannerMsg}</h2>
                                </div>
                            </div>
                        </div>

                        <div
                                class="slds-grid slds-wrap slds-grid_align-center slds-m-top_small slds-grid_pull-padded-x-small">
                            <!-- File -->
                            <aura:iteration items="{!v.generatedFiles}" var="file">
                                <div
                                        class="ds-generated-file slds-col slds-p-horizontal_x-small slds-m-vertical_x-small">
                                    <aura:if isTrue="{!not(empty(file))}">
                                        <c:GenFileTile file="{!file}" isEdit="{!false}" isClassic="{!v.isClassic}"/>
                                    </aura:if>
                                </div>
                            </aura:iteration>
                            <!-- /File -->
                        </div>

                        <!-- Failed Files -->
                        <aura:if isTrue="{!not(empty(v.failedFiles))}">
                            <div class="slds-m-top_small slds-text-align_left">
                                <lightning:icon class="ds-icon-fix slds-m-right_xx-small" iconName="utility:warning"
                                                variant="warning" size="x-small"/>
                                {!$Label.c.GenerateFileFailMsg}
                                <ul class="slds-list_dotted">
                                    <aura:iteration items="{!v.failedFiles}" var="failedFile">
                                        <li class="slds-item slds-m-top_xx-small">
                                            <p><strong>{!failedFile.title}</strong></p>
                                            <p>{!failedFile.message}</p>
                                        </li>
                                    </aura:iteration>
                                </ul>
                            </div>
                        </aura:if>
                        <!-- /Failed Files -->
                    </div>
                </aura:if>
            </aura:if>
        </aura:if>
    </div>
</aura:component>
